# ========================================
# MIGRATION - AUTHENTIFICATION ET MOD√âRATION
# ========================================

# IMPORTANT : Ex√©cutez ces commandes dans l'ordre

# ========================================
# √âTAPE 1 : Ajouter la variable d'environnement
# ========================================

# Ouvrez votre fichier .env et ajoutez cette ligne :
# ENABLE_REVIEW_MODERATION=false

# Vous pouvez aussi le faire en ligne de commande :
echo "ENABLE_REVIEW_MODERATION=false" >> .env

# ========================================
# √âTAPE 2 : Nettoyer les avis existants (OPTIONNEL)
# ========================================

# ‚ö†Ô∏è ATTENTION : Ceci supprime TOUS les avis existants !
# Si vous avez des avis en production, NE PAS EX√âCUTER

# Si vous √™tes en d√©veloppement et voulez repartir √† z√©ro :
# npx prisma studio
# Puis supprimez manuellement les avis depuis l'interface

# OU via SQL (√† vos risques et p√©rils) :
# DELETE FROM product_reviews;
# DELETE FROM review_replies;

# ========================================
# √âTAPE 3 : G√©n√©rer et appliquer la migration
# ========================================

npx prisma migrate dev --name add_reviews_authentication_moderation

# Cette commande va :
# - Cr√©er les nouveaux champs dans ProductReview (isApproved, moderatedBy, etc.)
# - Cr√©er les nouvelles relations entre User et ProductReview
# - Cr√©er les nouveaux index
# ‚ö†Ô∏è ATTENTION : userId devient obligatoire, les avis existants sans userId causeront une erreur

# ========================================
# √âTAPE 4 : R√©g√©n√©rer le client Prisma
# ========================================

npx prisma generate

# ========================================
# √âTAPE 5 : V√©rifier la base de donn√©es
# ========================================

npx prisma studio

# V√©rifiez que :
# - La table product_reviews a les nouveaux champs
# - La table users a les nouvelles relations
# - Aucune erreur de contrainte

# ========================================
# √âTAPE 6 : Red√©marrer le serveur
# ========================================

npm run dev

# ========================================
# √âTAPE 7 : Tester l'authentification
# ========================================

# 1. Ouvrez votre navigateur sur une page produit
# 2. Essayez de laisser un avis SANS √™tre connect√©
# 3. Vous devriez voir une popup "Vous devez √™tre connect√©..."
# 4. Connectez-vous
# 5. Le formulaire devrait √™tre pr√©-rempli avec vos informations
# 6. Soumettez un avis
# 7. L'avis devrait appara√Ætre imm√©diatement (si mod√©ration d√©sactiv√©e)

# ========================================
# √âTAPE 8 : Tester la mod√©ration (OPTIONNEL)
# ========================================

# Si vous voulez activer la mod√©ration :

# 1. Modifiez .env :
#    ENABLE_REVIEW_MODERATION=true

# 2. Red√©marrez le serveur :
#    npm run dev

# 3. Laissez un avis (connect√©)

# 4. V√©rifiez qu'il n'appara√Æt PAS sur le site

# 5. Allez dans l'admin : http://localhost:3000/ilm2
#    (ou votre URL admin)

# 6. Cliquez sur "Mod√©ration des avis" dans le menu

# 7. Vous devriez voir l'avis en attente

# 8. Approuvez-le

# 9. Retournez sur la page produit

# 10. L'avis devrait maintenant √™tre visible !

# ========================================
# EN CAS D'ERREUR
# ========================================

# Erreur : "userId cannot be null"
# Solution : Supprimez les avis existants ou assignez-leur un userId

# Erreur : "Table 'product_reviews' doesn't exist"
# Solution : V√©rifiez que la migration s'est bien appliqu√©e
#           npx prisma migrate status

# Erreur : "Cannot find module ReviewsModerationPage"
# Solution : V√©rifiez que le fichier existe dans :
#           app/(main)/view_admin/components/ReviewsModerationPage.tsx

# Erreur de build : "Property 'user' does not exist"
# Solution : V√©rifiez que le type User inclut les nouvelles relations
#           npx prisma generate

# ========================================
# POUR R√âINITIALISER COMPL√àTEMENT (D√âVELOPPEMENT UNIQUEMENT)
# ========================================

# ‚ö†Ô∏è ATTENTION : Ceci supprime TOUTE la base de donn√©es !

# npx prisma migrate reset
# npx prisma generate
# npm run dev

# ========================================
# POUR LA PRODUCTION
# ========================================

# Utilisez cette commande au lieu de migrate dev :
# npx prisma migrate deploy

# Assurez-vous d'avoir :
# 1. Sauvegard√© la base de donn√©es
# 2. Test√© en d√©veloppement/staging
# 3. Planifi√© une fen√™tre de maintenance
# 4. Pr√©par√© un plan de rollback

# ========================================
# SUPPORT
# ========================================

# Si vous rencontrez des probl√®mes :
# 1. Consultez AUTHENTICATION_AND_MODERATION_GUIDE.md
# 2. V√©rifiez les logs serveur
# 3. V√©rifiez les logs navigateur (F12 ‚Üí Console)
# 4. Utilisez npx prisma studio pour inspecter la BD

# ========================================
# ‚úÖ V√âRIFICATION FINALE
# ========================================

# Checklist :
# [ ] Variable ENABLE_REVIEW_MODERATION dans .env
# [ ] Migration appliqu√©e sans erreur
# [ ] Client Prisma r√©g√©n√©r√©
# [ ] Serveur d√©marr√© avec succ√®s
# [ ] Test authentification : Popup pour utilisateur non connect√© ‚úì
# [ ] Test authentification : Pr√©-remplissage formulaire ‚úì
# [ ] Test avis : Cr√©ation r√©ussie ‚úì
# [ ] Test avis : Visible sur le site (si pas de mod√©ration) ‚úì
# [ ] Test mod√©ration : Avis en attente visible dans admin (si mod√©ration) ‚úì
# [ ] Test mod√©ration : Approbation fonctionne (si mod√©ration) ‚úì

# Tout est pr√™t ! üéâ

