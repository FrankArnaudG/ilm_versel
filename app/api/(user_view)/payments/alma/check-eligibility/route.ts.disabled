// app/api/payments/alma/check-eligibility/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { almaClient, toAlmaCents, AlmaEligibilityRequest } from '@/lib/alma/alma-client';

/**
 * ============================================
 * POST - V√âRIFIER L'√âLIGIBILIT√â ALMA
 * ============================================
 * 
 * Cette route v√©rifie si un montant est √©ligible
 * au paiement en plusieurs fois avec Alma.
 * 
 * Utilis√©e pour afficher ou masquer les options Alma
 * dans le formulaire de paiement.
 */

export async function POST(req: NextRequest) {
  try {
    console.log('\nüîç ========================================');
    console.log('üîç V√âRIFICATION √âLIGIBILIT√â ALMA');
    console.log('üîç ========================================\n');

    // ----------------------------------------
    // 1. V√âRIFIER LA CONFIGURATION
    // ----------------------------------------
    if (!almaClient.isConfigured()) {
      console.error('‚ùå Alma non configur√©');
      return NextResponse.json(
        { 
          success: false,
          error: 'Alma non configur√©',
          eligible: false
        },
        { status: 500 }
      );
    }

    // ----------------------------------------
    // 2. R√âCUP√âRER LES DONN√âES
    // ----------------------------------------
    const { amount } = await req.json();

    console.log('üìã Montant √† v√©rifier:', amount, '‚Ç¨');

    if (!amount || amount <= 0) {
      return NextResponse.json(
        { 
          success: false,
          error: 'Montant invalide',
          eligible: false
        },
        { status: 400 }
      );
    }

    // ----------------------------------------
    // 3. V√âRIFICATION RAPIDE LOCALE
    // ----------------------------------------
    // Montants minimum et maximum pour Alma
    const MIN_AMOUNT = 50;  // 50‚Ç¨ minimum
    const MAX_AMOUNT = 2000; // 2000‚Ç¨ maximum

    if (amount < MIN_AMOUNT) {
      console.log('‚ùå Montant trop faible:', amount, '‚Ç¨ (min:', MIN_AMOUNT, '‚Ç¨)');
      return NextResponse.json({
        success: true,
        eligible: false,
        reason: `Le montant minimum pour Alma est de ${MIN_AMOUNT}‚Ç¨`,
        eligibility: {
          '2x': false,
          '3x': false,
          '4x': false
        }
      });
    }

    if (amount > MAX_AMOUNT) {
      console.log('‚ùå Montant trop √©lev√©:', amount, '‚Ç¨ (max:', MAX_AMOUNT, '‚Ç¨)');
      return NextResponse.json({
        success: true,
        eligible: false,
        reason: `Le montant maximum pour Alma est de ${MAX_AMOUNT}‚Ç¨`,
        eligibility: {
          '2x': false,
          '3x': false,
          '4x': false
        }
      });
    }

    // ----------------------------------------
    // 4. V√âRIFICATION AVEC L'API ALMA
    // ----------------------------------------
    console.log('üîÑ Appel API Alma pour v√©rification...');

    const eligibilityRequest: AlmaEligibilityRequest = {
      purchase_amount: toAlmaCents(amount),
      queries: [
        { installments_count: 2 },
        { installments_count: 3 },
        { installments_count: 4 }
      ]
    };

    const eligibilityResults = await almaClient.checkEligibility(eligibilityRequest);

    console.log('‚úÖ R√©sultats √©ligibilit√©:', eligibilityResults);

    // ----------------------------------------
    // 5. FORMATER LA R√âPONSE
    // ----------------------------------------
    const eligibility: Record<string, any> = {};
    let hasEligibleOption = false;

    for (const result of eligibilityResults) {
      const key = `${result.installments_count}x`;
      eligibility[key] = {
        eligible: result.eligible,
        installments: result.installments_count,
        customerFee: result.customer_fee,
        constraints: result.constraints
      };

      if (result.eligible) {
        hasEligibleOption = true;
      }
    }

    console.log('üìä √âligibilit√© format√©e:', eligibility);
    console.log(`${hasEligibleOption ? '‚úÖ' : '‚ùå'} Au moins une option √©ligible:`, hasEligibleOption);

    // ----------------------------------------
    // 6. R√âPONSE
    // ----------------------------------------
    console.log('\n‚úÖ ========================================');
    console.log('‚úÖ √âLIGIBILIT√â V√âRIFI√âE');
    console.log('‚úÖ ========================================\n');

    return NextResponse.json({
      success: true,
      eligible: hasEligibleOption,
      amount: amount,
      eligibility: eligibility,
      message: hasEligibleOption 
        ? 'Montant √©ligible au paiement en plusieurs fois' 
        : 'Montant non √©ligible au paiement en plusieurs fois'
    });

  } catch (error: any) {
    console.error('\n‚ùå ========================================');
    console.error('‚ùå ERREUR V√âRIFICATION √âLIGIBILIT√â');
    console.error('‚ùå ========================================');
    console.error(error);
    console.error('‚ùå ========================================\n');

    return NextResponse.json(
      { 
        success: false,
        eligible: false,
        error: 'Erreur lors de la v√©rification de l\'√©ligibilit√©',
        message: process.env.NODE_ENV === 'development' ? error.message : 'Une erreur est survenue'
      },
      { status: 500 }
    );
  }
}

/**
 * ============================================
 * GET - OBTENIR LES LIMITES ALMA
 * ============================================
 * 
 * Retourne les limites min/max pour l'affichage
 */

export async function GET(req: NextRequest) {
  return NextResponse.json({
    success: true,
    limits: {
      min: 50,
      max: 2000,
      currency: 'EUR'
    },
    installments: [2, 3, 4],
    message: 'Limites Alma pour les paiements en plusieurs fois'
  });
}