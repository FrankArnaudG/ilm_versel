// app/api/payments/alma/create-payment/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/lib/db';
import { almaClient, ALMA_URLS, toAlmaCents, AlmaPaymentData } from '@/lib/alma/alma-client';

/**
 * ============================================
 * POST - CR√âER UN PAIEMENT ALMA
 * ============================================
 * 
 * Cette route initialise un paiement Alma en plusieurs fois
 * et redirige l'utilisateur vers la page de paiement Alma.
 */

export async function POST(req: NextRequest) {
  try {
    console.log('\nüîµ ========================================');
    console.log('üîµ CR√âATION PAIEMENT ALMA');
    console.log('üîµ ========================================\n');

    // ----------------------------------------
    // 1. V√âRIFIER LA CONFIGURATION
    // ----------------------------------------
    if (!almaClient.isConfigured()) {
      console.error('‚ùå Alma non configur√© - Cl√©s API manquantes');
      return NextResponse.json(
        { 
          success: false,
          error: 'Le paiement Alma n\'est pas configur√©' 
        },
        { status: 500 }
      );
    }

    // ----------------------------------------
    // 2. R√âCUP√âRER LES DONN√âES
    // ----------------------------------------
    const { orderId, amount, installments } = await req.json();

    console.log('üìã Donn√©es re√ßues:', { orderId, amount, installments });

    // Validation
    if (!orderId || !amount || !installments) {
      return NextResponse.json(
        { 
          success: false,
          error: 'Donn√©es manquantes (orderId, amount, installments requis)' 
        },
        { status: 400 }
      );
    }

    // V√©rifier que le nombre de mensualit√©s est valide
    if (![2, 3, 4].includes(installments)) {
      return NextResponse.json(
        { 
          success: false,
          error: 'Nombre de mensualit√©s invalide (2, 3 ou 4 uniquement)' 
        },
        { status: 400 }
      );
    }

    // V√©rifier le montant minimum pour Alma (50‚Ç¨)
    if (amount < 50) {
      return NextResponse.json(
        { 
          success: false,
          error: `Le montant minimum pour un paiement en ${installments}x est de 50‚Ç¨` 
        },
        { status: 400 }
      );
    }

    // ----------------------------------------
    // 3. R√âCUP√âRER LA COMMANDE
    // ----------------------------------------
    console.log('üì¶ R√©cup√©ration de la commande:', orderId);

    const order = await db.order.findUnique({
      where: { id: orderId },
      include: {
        user: true,
        shippingAddress: true,
        billingAddress: true,
        items: {
          include: {
            article: {
              include: {
                model: true,
                color: true,
                variant: true
              }
            }
          }
        }
      }
    });

    if (!order) {
      console.error('‚ùå Commande introuvable:', orderId);
      return NextResponse.json(
        { 
          success: false,
          error: 'Commande introuvable' 
        },
        { status: 404 }
      );
    }

    // V√©rifier que la commande n'est pas d√©j√† pay√©e
    if (order.paymentStatus === 'SUCCEEDED') {
      console.error('‚ö†Ô∏è Commande d√©j√† pay√©e:', order.orderNumber);
      return NextResponse.json(
        { 
          success: false,
          error: 'Cette commande a d√©j√† √©t√© pay√©e' 
        },
        { status: 400 }
      );
    }

    // V√©rifier que le montant correspond
    const orderTotal = parseFloat(order.totalAmount.toString());
    if (Math.abs(orderTotal - amount) > 0.01) {
      console.error('‚ö†Ô∏è Montant incorrect:', { orderAmount: orderTotal, requestedAmount: amount });
      return NextResponse.json(
        { 
          success: false,
          error: 'Le montant ne correspond pas √† la commande' 
        },
        { status: 400 }
      );
    }

    console.log('‚úÖ Commande valid√©e:', {
      orderNumber: order.orderNumber,
      totalAmount: orderTotal,
      locality: order.locality
    });

    // ----------------------------------------
    // 4. PR√âPARER LES DONN√âES POUR ALMA
    // ----------------------------------------
    
    // S√©parer le nom complet
    const shippingNameParts = order.shippingAddress.fullName.split(' ');
    const shippingFirstName = shippingNameParts[0] || '';
    const shippingLastName = shippingNameParts.slice(1).join(' ') || shippingFirstName;

    const billingNameParts = order.billingAddress.fullName.split(' ');
    const billingFirstName = billingNameParts[0] || '';
    const billingLastName = billingNameParts.slice(1).join(' ') || billingFirstName;

    // Donn√©es du paiement Alma
    const almaPaymentData: AlmaPaymentData = {
      purchase_amount: toAlmaCents(amount), // Montant en centimes
      installments_count: installments,
      
      // Informations client
      customer: {
        email: order.user.email || '',
        first_name: shippingFirstName,
        last_name: shippingLastName,
        phone: order.shippingAddress.phone,
        addresses: [{
          line1: order.shippingAddress.addressLine1,
          line2: order.shippingAddress.addressLine2 || undefined,
          postal_code: order.shippingAddress.postalCode,
          city: order.shippingAddress.city,
          country: order.shippingAddress.country,
        }]
      },

      // Adresse de livraison
      shipping_address: {
        first_name: shippingFirstName,
        last_name: shippingLastName,
        line1: order.shippingAddress.addressLine1,
        line2: order.shippingAddress.addressLine2 || undefined,
        postal_code: order.shippingAddress.postalCode,
        city: order.shippingAddress.city,
        country: order.shippingAddress.country,
        phone: order.shippingAddress.phone,
      },

      // Adresse de facturation
      billing_address: {
        first_name: billingFirstName,
        last_name: billingLastName,
        line1: order.billingAddress.addressLine1,
        line2: order.billingAddress.addressLine2 || undefined,
        postal_code: order.billingAddress.postalCode,
        city: order.billingAddress.city,
        country: order.billingAddress.country,
      },

      // R√©f√©rence et m√©tadonn√©es
      merchant_reference: order.orderNumber,
      custom_data: {
        orderId: order.id,
        orderNumber: order.orderNumber,
        locality: order.locality
      },

      // URLs de callback
      return_url: `${ALMA_URLS.return_url}&order_id=${order.id}`,
      ipn_callback_url: ALMA_URLS.ipn_callback_url,
    };

    console.log('üìã Donn√©es Alma pr√©par√©es:', {
      amount: amount,
      installments: installments,
      merchant_reference: order.orderNumber,
      mode: almaClient.getMode()
    });

    // ----------------------------------------
    // 5. CR√âER LE PAIEMENT ALMA
    // ----------------------------------------
    console.log('üí≥ Cr√©ation du paiement Alma...');

    const almaPayment = await almaClient.createPayment(almaPaymentData);

    console.log('‚úÖ Paiement Alma cr√©√©:', {
      payment_id: almaPayment.id,
      url: almaPayment.url,
      state: almaPayment.state
    });

    // ----------------------------------------
    // 6. ENREGISTRER LE PAIEMENT EN BASE
    // ----------------------------------------
    console.log('üíæ Enregistrement dans la base de donn√©es...');

    const payment = await db.payment.create({
      data: {
        orderId: order.id,
        amount: amount,
        currency: 'EUR',
        provider: 'alma',
        providerPaymentId: almaPayment.id,
        status: 'PENDING',
        method: `ALMA_${installments}X` as any,
        installments: installments,
        installmentPlan: almaPayment.payment_plan as any,
        metadata: {
          alma_url: almaPayment.url,
          alma_state: almaPayment.state,
          customer_fee: almaPayment.customer_fee,
          mode: almaClient.getMode()
        }
      }
    });

    console.log('‚úÖ Paiement enregistr√© en BDD:', payment.id);

    // Mettre √† jour la commande
    await db.order.update({
      where: { id: order.id },
      data: {
        paymentProvider: 'alma',
        paymentIntentId: almaPayment.id,
        paymentStatus: 'PROCESSING'
      }
    });

    // Cr√©er l'historique
    await db.orderStatusHistory.create({
      data: {
        orderId: order.id,
        fromStatus: 'PENDING',
        toStatus: 'PENDING',
        note: `Paiement Alma ${installments}x initialis√© - ${almaPayment.id}`
      }
    });

    console.log('‚úÖ Commande mise √† jour');

    // ----------------------------------------
    // 7. R√âPONSE
    // ----------------------------------------
    console.log('\n‚úÖ ========================================');
    console.log('‚úÖ PAIEMENT ALMA CR√â√â AVEC SUCC√àS');
    console.log('‚úÖ ========================================\n');

    return NextResponse.json({
      success: true,
      paymentId: almaPayment.id,
      paymentUrl: almaPayment.url,
      installmentsCount: installments,
      paymentPlan: almaPayment.payment_plan,
      customerFee: almaPayment.customer_fee
    });

  } catch (error: any) {
    console.error('\n‚ùå ========================================');
    console.error('‚ùå ERREUR CR√âATION PAIEMENT ALMA');
    console.error('‚ùå ========================================');
    console.error(error);
    console.error('‚ùå ========================================\n');

    // Gestion des erreurs Alma sp√©cifiques
    if (error.message?.includes('amount')) {
      return NextResponse.json(
        { 
          success: false,
          error: 'Montant invalide pour Alma',
          message: error.message 
        },
        { status: 400 }
      );
    }

    if (error.message?.includes('eligibility')) {
      return NextResponse.json(
        { 
          success: false,
          error: 'Commande non √©ligible au paiement en plusieurs fois',
          message: error.message 
        },
        { status: 400 }
      );
    }

    return NextResponse.json(
      { 
        success: false,
        error: 'Erreur lors de l\'initialisation du paiement Alma',
        message: process.env.NODE_ENV === 'development' ? error.message : 'Une erreur est survenue'
      },
      { status: 500 }
    );
  }
}