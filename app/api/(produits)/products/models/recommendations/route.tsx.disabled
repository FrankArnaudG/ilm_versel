// import { db } from "@/lib/db";
// import { hasPermission } from "@/lib/permissions";
// import { Role, RecommendationType } from "@prisma/client";
// import { NextResponse } from "next/server";

// export async function POST(request: Request) {
//   try {
//     const payload = await request.json();
    
//     // ‚úÖ CORRECTION : Ne pas d√©structurer directement, utiliser payload
//     console.log('üì• Payload re√ßu:', {
//       hasDesignation: !!payload.designation,
//       hasBrand: !!payload.brand,
//       hasReference: !!payload.reference,
//       hasCategory: !!payload.category,
//       colorsCount: payload.colors?.length,
//       variantsCount: payload.variants?.length,
//       recommendationsCount: payload.recommendedProducts?.length
//     });

//     // ===========================
//     // 1. V√âRIFICATIONS DE BASE
//     // ===========================
    
//     if (!payload.user_id) {
//       return NextResponse.json({ message: 'Acc√®s refus√© - user_id manquant' }, { status: 403 });
//     }

//     if (!payload.designation || !payload.brand || !payload.reference || !payload.category) {
//       console.error('‚ùå Champs manquants:', {
//         designation: payload.designation,
//         brand: payload.brand,
//         reference: payload.reference,
//         category: payload.category
//       });
      
//       return NextResponse.json({ 
//         message: 'Champs obligatoires manquants',
//         missing: {
//           designation: !payload.designation,
//           brand: !payload.brand,
//           reference: !payload.reference,
//           category: !payload.category
//         }
//       }, { status: 400 });
//     }

//     // V√©rifier l'utilisateur
//     const user = await db.user.findUnique({
//       where: { id: payload.user_id },
//       include: {
//         secondaryRoles: true,
//         store: true
//       }
//     });

//     if (!user) {
//       return NextResponse.json({ message: 'Utilisateur non trouv√©' }, { status: 403 });
//     }

//     if (user.status !== 'ACTIVE') {
//       return NextResponse.json({ 
//         message: 'Compte utilisateur inactif ou suspendu' 
//       }, { status: 403 });
//     }

//     // ===========================
//     // 2. V√âRIFICATION DES R√îLES
//     // ===========================
    
//     const userRoles: Role[] = [user.role, ...user.secondaryRoles.map(sr => sr.role)];
//     const isRoleValid = userRoles.includes(payload.role as Role);

//     if (!isRoleValid) {
//       return NextResponse.json({ 
//         message: "Votre r√¥le est introuvable" 
//       }, { status: 403 });
//     }

//     if (payload.role !== user.role) {
//       const secondaryRole = user.secondaryRoles.find(sr => sr.role === payload.role);
//       if (secondaryRole?.expiresAt && new Date(secondaryRole.expiresAt) < new Date()) {
//         return NextResponse.json({ 
//           message: 'Ce r√¥le secondaire a expir√©' 
//         }, { status: 403 });
//       }
//     }

//     const canCreate = hasPermission(payload.role as Role, 'products.create');
    
//     if (!canCreate) {
//       return NextResponse.json({ 
//         message: "Vous n'√™tes pas autoris√© √† cr√©er des mod√®les de produits." 
//       }, { status: 403 });
//     }

//     // ===========================
//     // 3. VALIDATION DES RECOMMANDATIONS (SI PR√âSENTES)
//     // ===========================
    
//     if (payload.recommendedProducts && Array.isArray(payload.recommendedProducts) && payload.recommendedProducts.length > 0) {
//       const recommendedProductIds = payload.recommendedProducts.map((rp: any) => rp.recommendedProductId);
      
//       // V√©rifier l'existence des produits recommand√©s
//       const existingProducts = await db.productModel.findMany({
//         where: { 
//           id: { in: recommendedProductIds }
//         },
//         select: { id: true }
//       });

//       if (existingProducts.length !== recommendedProductIds.length) {
//         const foundIds = existingProducts.map(p => p.id);
//         const missingIds = recommendedProductIds.filter((id: string) => !foundIds.includes(id));
//         return NextResponse.json({ 
//           message: `Produits recommand√©s introuvables: ${missingIds.join(', ')}` 
//         }, { status: 404 });
//       }
//     }

//     // ===========================
//     // 4. CR√âATION DU MOD√àLE AVEC TRANSACTION
//     // ===========================

//     const result = await db.$transaction(async (tx) => {
//       // 4.1 Cr√©er le mod√®le
//       const newModel = await tx.productModel.create({
//         data: {
//           designation: payload.designation,
//           brand: payload.brand,
//           reference: payload.reference,
//           category: payload.category,
//           family: payload.family || null,
//           subFamily: payload.subFamily || null,
//           description: payload.description || null,
//           status: payload.status || 'DRAFT',
//           specifications: payload.specifications || {},
//           createdById: payload.user_id
//         }
//       });

//       console.log('‚úÖ Mod√®le cr√©√©:', newModel.id);

//       // 4.2 Cr√©er les couleurs avec images
//       if (payload.colors && Array.isArray(payload.colors) && payload.colors.length > 0) {
//         for (const color of payload.colors) {
//           const createdColor = await tx.productColor.create({
//             data: {
//               modelId: newModel.id,
//               colorName: color.colorName,
//               hexaColor: color.hexaColor
//             }
//           });

//           console.log(`‚úÖ Couleur cr√©√©e: ${color.colorName}`);

//           // Cr√©er les images pour cette couleur
//           if (color.images && Array.isArray(color.images) && color.images.length > 0) {
//             await tx.productImage.createMany({
//               data: color.images.map((img: any) => ({
//                 colorId: createdColor.id,
//                 url: img.url,
//                 fileName: img.fileName,
//                 displayOrder: img.displayOrder
//               }))
//             });

//             console.log(`‚úÖ ${color.images.length} image(s) cr√©√©e(s) pour ${color.colorName}`);
//           }
//         }
//       }

//       // 4.3 Cr√©er les variantes
//       if (payload.variants && Array.isArray(payload.variants) && payload.variants.length > 0) {
//         for (const variant of payload.variants) {
//           // G√©n√©rer une r√©f√©rence unique pour la variante
//           const variantReference = `${payload.reference}-${variant.storeId.substring(0, 8)}-${variant.variantAttribute || 'STD'}`.toUpperCase();
          
//           await tx.productVariant.create({
//             data: {
//               modelId: newModel.id,
//               storeId: variant.storeId,
//               variantReference: variantReference,
//               variantAttribute: variant.variantAttribute || null,
//               attributeType: variant.attributeType || 'NONE',
              
//               useFCFA: variant.useFCFA || false,
//               pvTTC: variant.pvTTC || 0,
//               pamp: variant.pamp || 0,
//               oldPrice: variant.oldPrice || 0,
//               margin: variant.margin || 0,
//               tva: variant.tva || 18,
              
//               pvTTC_FCFA: variant.pvTTC_FCFA || 0,
//               pamp_FCFA: variant.pamp_FCFA || 0,
//               oldPrice_FCFA: variant.oldPrice_FCFA || 0,
//               marginFCFA: variant.marginFCFA || 0,
//               marginPercent: variant.marginPercent || 0
//             }
//           });
//         }

//         console.log(`‚úÖ ${payload.variants.length} variante(s) cr√©√©e(s)`);
//       }

//       // 4.4 Cr√©er les recommandations
//       if (payload.recommendedProducts && Array.isArray(payload.recommendedProducts) && payload.recommendedProducts.length > 0) {
//         await tx.recommendedProduct.createMany({
//           data: payload.recommendedProducts.map((rp: any) => ({
//             mainProductId: newModel.id,
//             recommendedProductId: rp.recommendedProductId,
//             priority: rp.priority ?? 5,
//             relationType: (rp.relationType as RecommendationType) ?? 'ACCESSORY',
//             bundleDiscount: rp.bundleDiscount ? parseFloat(rp.bundleDiscount.toString()) : null,
//             bundlePrice: rp.bundlePrice ? parseFloat(rp.bundlePrice.toString()) : null,
//             description: rp.description || null,
//             isActive: true,
//             createdById: payload.user_id
//           }))
//         });

//         console.log(`‚úÖ ${payload.recommendedProducts.length} recommandation(s) cr√©√©e(s)`);
//       }

//       return newModel;
//     });

//     // ===========================
//     // 5. RETOUR SUCCESS
//     // ===========================
    
//     console.log('üéâ Cr√©ation compl√®te du mod√®le:', result.id);
    
//     return NextResponse.json({
//       success: true,
//       message: 'Mod√®le cr√©√© avec succ√®s',
//       model: {
//         id: result.id,
//         designation: result.designation,
//         reference: result.reference
//       },
//       summary: {
//         colors: payload.colors?.length || 0,
//         variants: payload.variants?.length || 0,
//         recommendations: payload.recommendedProducts?.length || 0
//       }
//     }, { status: 201 });

//   } catch (error: any) {
//     console.error('‚ùå Erreur cr√©ation mod√®le:', error);
    
//     // Gestion des erreurs Prisma
//     if (error.code === 'P2002') {
//       return NextResponse.json(
//         { 
//           success: false,
//           message: 'Un mod√®le avec cette r√©f√©rence existe d√©j√†' 
//         },
//         { status: 409 }
//       );
//     }

//     if (error.code === 'P2003') {
//       return NextResponse.json(
//         { 
//           success: false,
//           message: 'R√©f√©rence invalide (boutique, couleur ou produit recommand√© introuvable)' 
//         },
//         { status: 400 }
//       );
//     }

//     return NextResponse.json(
//       { 
//         success: false,
//         message: 'Erreur lors de la cr√©ation du mod√®le',
//         error: process.env.NODE_ENV === 'development' ? error.message : undefined
//       },
//       { status: 500 }
//     );
//   }
// }