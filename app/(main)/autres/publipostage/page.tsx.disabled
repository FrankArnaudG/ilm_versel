/**
 * MODULE DE PUBLIPOSTAGE VISUEL - Next.js + TypeScript + Tailwind CSS
 * 
 * GUIDE D&apos;UTILISATION :
 * 1. Installer les d√©pendances : npm install xlsx jspdf html2canvas react-hook-form
 * 2. Placer ce fichier dans /app/publipostage/page.tsx
 * 3. Cr√©er les composants dans /components/publipostage/
 * 4. Lancer l'application : npm run dev
 * 5. Acc√©der √† : http://localhost:3000/publipostage
 * 
 * FONCTIONNALIT√âS :
 * - Upload fichier Excel (.xlsx) ou CSV
 * - Mapping des colonnes avec les champs attendus
 * - G√©n√©ration automatique d&apos;√©tiquettes produits (4 par page A4)
 * - Aper√ßu visuel avec pagination
 * - Export PDF complet
 */

'use client';

import { useState, useRef, useEffect, ChangeEvent } from 'react';
import * as XLSX from 'xlsx';

export type ProductData = {
  model: string;
  screen: string;
  os: string;
  battery: string;
  cpu: string;
  camera: string;
  memory: string;
  storage: string;
  connectivity: string;
  sim: string;
  note: string;
  price: string;
};

export type FieldMapping = {
  [key in keyof ProductData]: string;
};

// Configuration des champs attendus avec leurs labels
export const fieldConfig: FieldMapping = {
  model: "Nom du mod√®le",
  screen: "Taille d&apos;√©cran",
  os: "Syst√®me d&apos;exploitation",
  battery: "Batterie",
  cpu: "Processeur",
  camera: "Cam√©ra",
  memory: "M√©moire vive (RAM)",
  storage: "Stockage",
  connectivity: "Connectivit√©",
  sim: "SIM",
  note: "Note",
  price: "Prix"
};

export default function PublipostagePage() {
  // √âtats de gestion du workflow
  const [step, setStep] = useState<1 | 2 | 3>(1);
  const [fileHeaders, setFileHeaders] = useState<string[]>([]);
  const [rawData, setRawData] = useState<Record<string, string>[]>([]);
  const [mappedData, setMappedData] = useState<ProductData[]>([]);
  const [selectedRows, setSelectedRows] = useState<number[]>([]);

  /**
   * Callback apr√®s upload r√©ussi du fichier
   * R√©cup√®re les en-t√™tes et les donn√©es brutes
   */
  const handleFileUploaded = (headers: string[], data: Record<string, string>[]) => {
    setFileHeaders(headers);
    setRawData(data);
    setStep(2);
    // S√©lectionner toutes les lignes par d√©faut
    setSelectedRows(data.map((_, index) => index));
  };

  /**
   * Callback apr√®s validation du mapping
   * Transforme les donn√©es brutes en donn√©es format√©es
   */
  const handleMappingValidated = (mapping: Record<string, string>) => {
    const transformed = rawData
      .filter((_, index) => selectedRows.includes(index))
      .map((row) => {
        const product: Partial<ProductData> = {};
        Object.keys(fieldConfig).forEach((field) => {
          const columnName = mapping[field];
          product[field as keyof ProductData] = columnName ? row[columnName] || '' : '';
        });
        return product as ProductData;
      });
    
    setMappedData(transformed);
    setStep(3);
  };

  /**
   * Retour √† l'√©tape pr√©c√©dente
   */
  const handleBack = () => {
    if (step > 1) {
      setStep((step - 1) as 1 | 2);
    }
  };

  /**
   * R√©initialiser compl√®tement le module
   */
  const handleReset = () => {
    setStep(1);
    setFileHeaders([]);
    setRawData([]);
    setMappedData([]);
    setSelectedRows([]);
  };

  // Calcul du nombre de pages n√©cessaires (4 √©tiquettes par page)
  const totalLabels = mappedData.length;
  const totalPages = Math.ceil(totalLabels / 4);

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-8 px-4">
      <div className="max-w-7xl mx-auto">
        {/* En-t√™te */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">
            Module de Publipostage
          </h1>
          <p className="text-gray-600">
            G√©n√©ration automatique d&apos;√©tiquettes produits √† partir d&apos;Excel ou CSV
          </p>
        </div>

        {/* Indicateur de progression */}
        <div className="flex justify-center items-center mb-8 space-x-4">
          <StepIndicator number={1} label="Upload" active={step === 1} completed={step > 1} />
          <div className="w-16 h-1 bg-gray-300">
            <div className={`h-full bg-blue-600 transition-all ${step > 1 ? 'w-full' : 'w-0'}`} />
          </div>
          <StepIndicator number={2} label="Mapping" active={step === 2} completed={step > 2} />
          <div className="w-16 h-1 bg-gray-300">
            <div className={`h-full bg-blue-600 transition-all ${step > 2 ? 'w-full' : 'w-0'}`} />
          </div>
          <StepIndicator number={3} label="Aper√ßu" active={step === 3} completed={false} />
        </div>

        {/* Contenu selon l'√©tape */}
        <div className="bg-white rounded-xl shadow-lg p-8">
          {step === 1 && (
            <FileUploader onFileUploaded={handleFileUploaded} />
          )}

          {step === 2 && (
            <MappingForm
              headers={fileHeaders}
              fieldConfig={fieldConfig}
              rawData={rawData}
              selectedRows={selectedRows}
              onSelectedRowsChange={setSelectedRows}
              onValidate={handleMappingValidated}
              onBack={handleBack}
            />
          )}

          {step === 3 && (
            <div>
              {/* R√©sum√© */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-6">
                    <div className="text-center">
                      <div className="text-3xl font-bold text-blue-600">{totalLabels}</div>
                      <div className="text-sm text-gray-600">√âtiquettes g√©n√©r√©es</div>
                    </div>
                    <div className="text-center">
                      <div className="text-3xl font-bold text-blue-600">{totalPages}</div>
                      <div className="text-sm text-gray-600">Pages cr√©√©es</div>
                    </div>
                    <div className="text-center">
                      <div className="text-lg font-semibold text-blue-600">A4</div>
                      <div className="text-sm text-gray-600">Pr√™t √† imprimer</div>
                    </div>
                  </div>
                  <div className="flex space-x-3">
                    <button
                      onClick={handleBack}
                      className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                    >
                      ‚Üê Retour
                    </button>
                    <button
                      onClick={handleReset}
                      className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                    >
                      Nouveau fichier
                    </button>
                    <ExportPDFButton data={mappedData} />
                  </div>
                </div>
              </div>

              {/* Grille d&apos;aper√ßu */}
              <LabelsGrid data={mappedData} />
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

/**
 * Composant indicateur d&apos;√©tape
 */
function StepIndicator({ number, label, active, completed }: {
  number: number;
  label: string;
  active: boolean;
  completed: boolean;
}) {
  return (
    <div className="flex flex-col items-center">
      <div
        className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold transition ${
          completed
            ? 'bg-green-500 text-white'
            : active
            ? 'bg-blue-600 text-white'
            : 'bg-gray-300 text-gray-600'
        }`}
      >
        {completed ? '‚úì' : number}
      </div>
      <div className={`text-sm mt-1 ${active ? 'text-blue-600 font-semibold' : 'text-gray-500'}`}>
        {label}
      </div>
    </div>
  );
}






/**
 * COMPOSANT : FileUploader
 * Gestion de l'upload de fichiers Excel (.xlsx) ou CSV
 * Lecture automatique des en-t√™tes et des donn√©es
 */

interface FileUploaderProps {
  onFileUploaded: (headers: string[], data: Record<string, string>[]) => void;
}

function FileUploader({ onFileUploaded }: FileUploaderProps) {
  const [isDragging, setIsDragging] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  /**
   * Traitement du fichier upload√©
   * Supporte .xlsx, .xls et .csv
   */
  const processFile = (file: File) => {
    setIsProcessing(true);
    setError(null);

    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const data = e.target?.result;
        let workbook: XLSX.WorkBook;

        // Traitement diff√©rent selon le type de fichier
        if (file.name.endsWith('.csv')) {
          const text = new TextDecoder().decode(data as ArrayBuffer);
          workbook = XLSX.read(text, { type: 'string' });
        } else {
          workbook = XLSX.read(data, { type: 'array' });
        }

        // R√©cup√©ration de la premi√®re feuille
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }) as (string | number)[][];

        if (jsonData.length === 0) {
          throw new Error('Le fichier est vide');
        }

        const headers = jsonData[0].map(h => String(h));

        const rows = jsonData.slice(1).map((row) => {
          const rowData: Record<string, string> = {};
          headers.forEach((header, index) => {
            rowData[header] = row[index] !== undefined ? String(row[index]) : '';
          });
          return rowData;
        });

        // Filtrer les lignes compl√®tement vides
        const filteredRows = rows.filter((row) => 
          Object.values(row).some((val) => val !== '')
        );

        if (filteredRows.length === 0) {
          throw new Error('Aucune donn√©e trouv√©e dans le fichier');
        }

        // Callback avec les donn√©es trait√©es
        onFileUploaded(headers, filteredRows);
      } catch (err) {
        console.error('Erreur lors du traitement du fichier:', err);
        setError(err instanceof Error ? err.message : 'Erreur lors de la lecture du fichier');
      } finally {
        setIsProcessing(false);
      }
    };

    reader.onerror = () => {
      setError('Erreur lors de la lecture du fichier');
      setIsProcessing(false);
    };

    // Lecture du fichier
    reader.readAsArrayBuffer(file);
  };

  /**
   * Gestion du changement de fichier (input classique)
   */
  const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      validateAndProcess(file);
    }
  };

  /**
   * Validation et traitement du fichier
   */
  const validateAndProcess = (file: File) => {
    const validExtensions = ['.xlsx', '.xls', '.csv'];
    const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

    if (!validExtensions.includes(fileExtension)) {
      setError('Format de fichier non support√©. Veuillez utiliser .xlsx, .xls ou .csv');
      return;
    }

    if (file.size > 10 * 1024 * 1024) { // 10 MB max
      setError('Le fichier est trop volumineux (max 10 MB)');
      return;
    }

    processFile(file);
  };

  /**
   * Gestion du drag & drop
   */
  const handleDragEnter = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(true);
  };

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);

    const file = e.dataTransfer.files[0];
    if (file) {
      validateAndProcess(file);
    }
  };

  /**
   * Ouverture du s√©lecteur de fichiers
   */
  const handleClick = () => {
    fileInputRef.current?.click();
  };

  return (
    <div className="w-full max-w-2xl mx-auto">
      <h2 className="text-2xl font-bold text-gray-800 mb-4 text-center">
        Importer votre fichier
      </h2>
      <p className="text-gray-600 text-center mb-6">
        Formats accept√©s : Excel (.xlsx, .xls) ou CSV (.csv)
      </p>

      {/* Zone de drag & drop */}
      <div
        onClick={handleClick}
        onDragEnter={handleDragEnter}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
        className={`
          relative border-2 border-dashed rounded-xl p-12 text-center cursor-pointer
          transition-all duration-200 ease-in-out
          ${isDragging 
            ? 'border-blue-500 bg-blue-50 scale-105' 
            : 'border-gray-300 bg-gray-50 hover:border-blue-400 hover:bg-blue-50'
          }
          ${isProcessing ? 'opacity-50 cursor-wait' : ''}
        `}
      >
        <input
          ref={fileInputRef}
          type="file"
          accept=".xlsx,.xls,.csv"
          onChange={handleFileChange}
          className="hidden"
          disabled={isProcessing}
        />

        {isProcessing ? (
          <div className="space-y-4">
            <div className="animate-spin w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto" />
            <p className="text-gray-600 font-medium">Traitement du fichier en cours...</p>
          </div>
        ) : (
          <div className="space-y-4">
            <svg
              className="w-16 h-16 mx-auto text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            <div>
              <p className="text-lg font-semibold text-gray-700">
                Glissez-d√©posez votre fichier ici
              </p>
              <p className="text-sm text-gray-500 mt-1">
                ou cliquez pour s√©lectionner un fichier
              </p>
            </div>
            <div className="flex items-center justify-center space-x-2 text-sm text-gray-500">
              <span>üìä Excel</span>
              <span>‚Ä¢</span>
              <span>üìÑ CSV</span>
              <span>‚Ä¢</span>
              <span>Max 10 MB</span>
            </div>
          </div>
        )}
      </div>

      {/* Affichage des erreurs */}
      {error && (
        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div className="flex items-start">
            <svg
              className="w-5 h-5 text-red-500 mr-2 flex-shrink-0 mt-0.5"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fillRule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                clipRule="evenodd"
              />
            </svg>
            <div>
              <h3 className="text-sm font-medium text-red-800">Erreur</h3>
              <p className="text-sm text-red-700 mt-1">{error}</p>
            </div>
          </div>
        </div>
      )}

      {/* Informations compl√©mentaires */}
      <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h3 className="text-sm font-semibold text-blue-900 mb-2">
          üí° Conseils pour un meilleur r√©sultat
        </h3>
        <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
          <li>Assurez-vous que la premi√®re ligne contient les en-t√™tes de colonnes</li>
          <li>√âvitez les cellules fusionn√©es dans votre fichier</li>
          <li>Les colonnes vides seront ignor√©es</li>
          <li>Vous pourrez s√©lectionner les lignes √† inclure √† l&apos;√©tape suivante</li>
        </ul>
      </div>
    </div>
  );
}



/**
 * COMPOSANT : MappingForm
 * Interface de correspondance entre les colonnes du fichier et les champs attendus
 * Permet √©galement de s√©lectionner/d√©s√©lectionner les lignes √† inclure
 */

interface MappingFormProps {
  headers: string[];
  fieldConfig: FieldMapping;
  rawData: Record<string, string>[];
  selectedRows: number[];
  onSelectedRowsChange: (selected: number[]) => void;
  onValidate: (mapping: Record<string, string>) => void;
  onBack: () => void;
}

function MappingForm({
  headers,
  fieldConfig,
  rawData,
  selectedRows,
  onSelectedRowsChange,
  onValidate,
  onBack
}: MappingFormProps) {
  // √âtat du mapping : cl√© = champ attendu, valeur = colonne du fichier
  const [mapping, setMapping] = useState<Record<string, string>>({});
  const [autoMapped, setAutoMapped] = useState(false);

  /**
   * Auto-d√©tection des correspondances au chargement
   * Compare les en-t√™tes du fichier avec les labels des champs
   */
  useEffect(() => {
    if (!autoMapped && headers.length > 0) {
      const initialMapping: Record<string, string> = {};
      
      Object.entries(fieldConfig).forEach(([fieldKey, fieldLabel]) => {
        // Recherche exacte (insensible √† la casse)
        const exactMatch = headers.find(
          (h) => h.toLowerCase() === fieldLabel.toLowerCase()
        );
        
        if (exactMatch) {
          initialMapping[fieldKey] = exactMatch;
        } else {
          // Recherche partielle (mots-cl√©s)
          const keywords = fieldLabel.toLowerCase().split(' ');
          const partialMatch = headers.find((h) => {
            const headerLower = h.toLowerCase();
            return keywords.some((keyword) => headerLower.includes(keyword));
          });
          
          if (partialMatch) {
            initialMapping[fieldKey] = partialMatch;
          }
        }
      });
      
      setMapping(initialMapping);
      setAutoMapped(true);
    }
  }, [headers, fieldConfig, autoMapped]);

  /**
   * Mise √† jour d&apos;une correspondance
   */
  const handleMappingChange = (fieldKey: string, columnName: string) => {
    setMapping((prev) => ({
      ...prev,
      [fieldKey]: columnName
    }));
  };

  /**
   * S√©lection/d√©s√©lection d&apos;une ligne
   */
  const toggleRowSelection = (index: number) => {
    if (selectedRows.includes(index)) {
      onSelectedRowsChange(selectedRows.filter((i) => i !== index));
    } else {
      onSelectedRowsChange([...selectedRows, index]);
    }
  };

  /**
   * S√©lectionner toutes les lignes
   */
  const selectAll = () => {
    onSelectedRowsChange(rawData.map((_, index) => index));
  };

  /**
   * D√©s√©lectionner toutes les lignes
   */
  const deselectAll = () => {
    onSelectedRowsChange([]);
  };

  /**
   * Validation du mapping
   */
  const handleValidate = () => {
    if (selectedRows.length === 0) {
      alert('Veuillez s√©lectionner au moins une ligne');
      return;
    }

    // V√©rifier qu'au moins un champ important est mapp√©
    const hasCriticalMapping = mapping.model || mapping.price;
    if (!hasCriticalMapping) {
      const confirm = window.confirm(
        'Aucun champ "Mod√®le" ou "Prix" n\'est mapp√©. Voulez-vous continuer quand m√™me ?'
      );
      if (!confirm) return;
    }

    onValidate(mapping);
  };

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h2 className="text-2xl font-bold text-gray-800 mb-2">
          Correspondance des colonnes
        </h2>
        <p className="text-gray-600">
          Associez les colonnes de votre fichier aux champs des √©tiquettes
        </p>
      </div>

      {/* Tableau de mapping */}
      <div className="bg-gray-50 rounded-lg p-6 border border-gray-200">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">
          Mapping des champs
        </h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {Object.entries(fieldConfig).map(([fieldKey, fieldLabel]) => (
            <div key={fieldKey} className="flex items-center space-x-3">
              <label className="w-40 text-sm font-medium text-gray-700 flex-shrink-0">
                {fieldLabel}
                {(fieldKey === 'model' || fieldKey === 'price') && (
                  <span className="text-red-500 ml-1">*</span>
                )}
              </label>
              <select
                value={mapping[fieldKey] || ''}
                onChange={(e) => handleMappingChange(fieldKey, e.target.value)}
                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-sm"
              >
                <option value="">-- Ignorer --</option>
                {headers.map((header) => (
                  <option key={header} value={header}>
                    {header}
                  </option>
                ))}
              </select>
            </div>
          ))}
        </div>
        <p className="text-xs text-gray-500 mt-3">
          * Champs recommand√©s pour un meilleur rendu
        </p>
      </div>

      {/* S√©lection des lignes */}
      <div className="bg-gray-50 rounded-lg p-6 border border-gray-200">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold text-gray-800">
            S√©lection des produits ({selectedRows.length}/{rawData.length})
          </h3>
          <div className="space-x-2">
            <button
              onClick={selectAll}
              className="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition"
            >
              Tout s√©lectionner
            </button>
            <button
              onClick={deselectAll}
              className="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition"
            >
              Tout d√©s√©lectionner
            </button>
          </div>
        </div>

        {/* Tableau des donn√©es */}
        <div className="max-h-96 overflow-auto border border-gray-300 rounded-lg">
          <table className="w-full text-sm">
            <thead className="bg-gray-100 sticky top-0">
              <tr>
                <th className="px-3 py-2 text-left w-12">
                  <input
                    type="checkbox"
                    checked={selectedRows.length === rawData.length}
                    onChange={(e) => {
                      if (e.target.checked) {
                        selectAll();
                      } else {
                        deselectAll();
                      }
                    }}
                    className="w-4 h-4"
                  />
                </th>
                <th className="px-3 py-2 text-left font-semibold text-gray-700">#</th>
                {headers.slice(0, 5).map((header) => (
                  <th key={header} className="px-3 py-2 text-left font-semibold text-gray-700">
                    {header}
                  </th>
                ))}
                {headers.length > 5 && (
                  <th className="px-3 py-2 text-left font-semibold text-gray-700">
                    ... +{headers.length - 5} colonnes
                  </th>
                )}
              </tr>
            </thead>
            <tbody>
              {rawData.map((row, index) => (
                <tr
                  key={index}
                  className={`border-t border-gray-200 hover:bg-blue-50 transition ${
                    selectedRows.includes(index) ? 'bg-blue-50' : 'bg-white'
                  }`}
                >
                  <td className="px-3 py-2">
                    <input
                      type="checkbox"
                      checked={selectedRows.includes(index)}
                      onChange={() => toggleRowSelection(index)}
                      className="w-4 h-4"
                    />
                  </td>
                  <td className="px-3 py-2 text-gray-500">{index + 1}</td>
                  {headers.slice(0, 5).map((header) => (
                    <td key={header} className="px-3 py-2 text-gray-800 truncate max-w-xs">
                      {row[header] || '-'}
                    </td>
                  ))}
                  {headers.length > 5 && (
                    <td className="px-3 py-2 text-gray-400 text-xs">...</td>
                  )}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Boutons d&apos;action */}
      <div className="flex justify-between items-center pt-4">
        <button
          onClick={onBack}
          className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium"
        >
          ‚Üê Retour
        </button>
        <button
          onClick={handleValidate}
          disabled={selectedRows.length === 0}
          className={`px-6 py-3 rounded-lg font-medium transition ${
            selectedRows.length === 0
              ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
              : 'bg-blue-600 text-white hover:bg-blue-700'
          }`}
        >
          Valider et g√©n√©rer les √©tiquettes ‚Üí
        </button>
      </div>
    </div>
  );
}


/**
 * COMPOSANT : LabelPreview
 * Affichage d&apos;une √©tiquette produit individuelle
 * Design conforme au mod√®le : logo I Love Mobile, caract√©ristiques, prix
 */

interface LabelPreviewProps {
  data: ProductData;
}

/**
 * COMPOSANT : LabelPreview
 * Affichage d&apos;une √©tiquette produit individuelle
 * Design avec logo image, caract√©ristiques align√©es et prix en grand
 */

import Image from 'next/image';

interface LabelPreviewProps {
  data: ProductData;
}

/**
 * COMPOSANT : LabelPreview
 * Affichage d&apos;une √©tiquette produit individuelle
 * Design sobre avec logo image, caract√©ristiques √† puces align√©es √† gauche, prix en bas
 */

interface LabelPreviewProps {
  data: ProductData;
}

function LabelPreview({ data }: LabelPreviewProps) {
  return (
    <div className="label-card border border-black bg-white p-4 flex flex-col h-full rounded-none">
      {/* Logo I Love Mobile - Image centr√©e */}
      <div className="flex justify-center mb-2.5">
        <Image
          src="/assets/logo_ilm.png"
          alt="I Love Mobile"
          width={150}
          height={75}
          className="object-contain"
          priority
        />
      </div>

      {/* Mod√®le du t√©l√©phone, majuscules, centr√© */}
      <div className="mb-3 text-center">
        <h3 className="text-xl font-bold text-black uppercase underline leading-tight">
          {data.model || 'MOD√àLE NON D√âFINI'}
        </h3>
      </div>

      {/* Caract√©ristiques principales - √Ä gauche avec puces */}
      <div className="flex-grow mb-3">
        <div className="text-base text-gray-800 leading-relaxed space-y-0.5">
          {data.screen && (
            <div className="flex items-start">
              <span className="mr-1.5">‚Ä¢</span>
              <span>
                <span className="font-bold">√âcran:</span> {data.screen}
              </span>
            </div>
          )}
          {data.os && (
            <div className="flex items-start">
              <span className="mr-1.5">‚Ä¢</span>
              <span>
                <span className="font-bold">OS:</span> {data.os}
              </span>
            </div>
          )}
          {data.battery && (
            <div className="flex items-start">
              <span className="mr-1.5">‚Ä¢</span>
              <span>
                <span className="font-bold">Batterie:</span> {data.battery}
              </span>
            </div>
          )}
          {data.cpu && (
            <div className="flex items-start">
              <span className="mr-1.5">‚Ä¢</span>
              <span>
                <span className="font-bold">CPU:</span> {data.cpu}
              </span>
            </div>
          )}
          {data.camera && (
            <div className="flex items-start">
              <span className="mr-1.5">‚Ä¢</span>
              <span>
                <span className="font-bold">Cam√©ra:</span> {data.camera}
              </span>
            </div>
          )}
          {data.memory && (
            <div className="flex items-start">
              <span className="mr-1.5">‚Ä¢</span>
              <span>
                <span className="font-bold">RAM:</span> {data.memory}
              </span>
            </div>
          )}
          {data.storage && (
            <div className="flex items-start">
              <span className="mr-1.5">‚Ä¢</span>
              <span>
                <span className="font-bold">Stockage:</span> {data.storage}
              </span>
            </div>
          )}
          {data.connectivity && (
            <div className="flex items-start">
              <span className="mr-1.5">‚Ä¢</span>
              <span>
                <span className="font-bold">R√©seau:</span> {data.connectivity}
              </span>
            </div>
          )}
          {data.sim && (
            <div className="flex items-start">
              <span className="mr-1.5">‚Ä¢</span>
              <span>
                <span className="font-bold">SIM:</span> {data.sim}
              </span>
            </div>
          )}
        </div>
      </div>

      {/* Prix uniquement - Section inf√©rieure avec bordure */}
      <div className="mt-auto pt-3 border-t border-gray-300">
        {data.price && (
          <div className="text-center">
            <div className="text-2xl font-bold text-green-700">
              {formatPrice(data.price)}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}


/**
 * COMPOSANT : LabelsGrid
 * Affichage de toutes les √©tiquettes en grille (4 par page A4)
 * Mise en page : 2 colonnes √ó 2 lignes par page
 */


interface LabelsGridProps {
  data: ProductData[];
}

function LabelsGrid({ data }: LabelsGridProps) {
  // Grouper les donn√©es par page (4 √©tiquettes par page)
  const LABELS_PER_PAGE = 4;
  const pages: ProductData[][] = [];
  
  for (let i = 0; i < data.length; i += LABELS_PER_PAGE) {
    pages.push(data.slice(i, i + LABELS_PER_PAGE));
  }

  return (
    <div className="space-y-8">
      <h2 className="text-2xl font-bold text-gray-800 text-center mb-6">
        Aper√ßu des √©tiquettes
      </h2>

      {pages.map((pageData, pageIndex) => (
        <div key={pageIndex} className="page-container">
          {/* Indicateur de page */}
          <div className="flex items-center justify-between mb-4 px-4">
            <div className="text-sm text-gray-600">
              Page {pageIndex + 1} / {pages.length}
            </div>
            <div className="text-sm text-gray-600">
              √âtiquettes {pageIndex * LABELS_PER_PAGE + 1} √†{' '}
              {Math.min((pageIndex + 1) * LABELS_PER_PAGE, data.length)} sur {data.length}
            </div>
          </div>

          {/* Page A4 simul√©e */}
          <div
            id={`page-${pageIndex}`}
            className="a4-page bg-white shadow-lg mx-auto p-8 rounded-lg"
            style={{
              width: '210mm',
              minHeight: '297mm',
              maxWidth: '100%'
            }}
          >
            {/* Grille 2x2 */}
            <div className="grid grid-cols-2 gap-6 h-full">
              {pageData.map((product, labelIndex) => (
                <div
                  key={labelIndex}
                  className="label-wrapper"
                  style={{
                    minHeight: '135mm'
                  }}
                >
                  <LabelPreview data={product} />
                </div>
              ))}
              
              {/* Remplissage pour les cases vides si moins de 4 √©tiquettes sur la derni√®re page */}
              {pageData.length < LABELS_PER_PAGE &&
                Array.from({ length: LABELS_PER_PAGE - pageData.length }).map((_, i) => (
                  <div
                    key={`empty-${i}`}
                    className="label-wrapper border border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-400"
                    style={{
                      minHeight: '135mm'
                    }}
                  >
                    <span className="text-sm">Espace disponible</span>
                  </div>
                ))}
            </div>
          </div>
        </div>
      ))}

      {/* Informations pour l'impression */}
      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 max-w-4xl mx-auto">
        <h3 className="text-sm font-semibold text-yellow-900 mb-2">
          üìÑ Conseils pour l&apos;impression
        </h3>
        <ul className="text-sm text-yellow-800 space-y-1 list-disc list-inside">
          <li>Format : A4 (210 √ó 297 mm)</li>
          <li>Orientation : Portrait</li>
          <li>Marges : Normales (environ 2 cm de chaque c√¥t√©)</li>
          <li>Qualit√© : Haute r√©solution pour une meilleure lisibilit√©</li>
          <li>Papier : Papier photo ou autocollant recommand√©</li>
        </ul>
      </div>
    </div>
  );
}

/**
 * COMPOSANT : ExportPDFButton
 * G√©n√©ration et export du PDF avec toutes les √©tiquettes
 * Utilise html2canvas pour capturer les pages et jspdf pour cr√©er le PDF
 */
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';

interface ExportPDFButtonProps {
  data: ProductData[];
}

function ExportPDFButton({ data }: ExportPDFButtonProps) {
  const [isGenerating, setIsGenerating] = useState(false);
  const [progress, setProgress] = useState(0);

  /**
   * G√©n√©ration du PDF
   * Capture chaque page A4 et l'ajoute au PDF
   */
  const generatePDF = async () => {
    try {
      setIsGenerating(true);
      setProgress(0);

      // Calculer le nombre de pages
      const LABELS_PER_PAGE = 4;
      const totalPages = Math.ceil(data.length / LABELS_PER_PAGE);

      // Cr√©er le document PDF (format A4 : 210 √ó 297 mm)
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      // Capturer et ajouter chaque page
      for (let i = 0; i < totalPages; i++) {
        const pageElement = document.getElementById(`page-${i}`);
        
        if (!pageElement) {
          console.warn(`Page ${i} non trouv√©e`);
          continue;
        }

        // Mettre √† jour la progression
        setProgress(Math.round(((i + 1) / totalPages) * 100));

        // Attendre un peu pour laisser le navigateur se mettre √† jour
        await new Promise(resolve => setTimeout(resolve, 100));

        // Capturer la page en haute r√©solution
        const canvas = await html2canvas(pageElement, {
            useCORS: true,
            logging: false,
            background: '#ffffff'
        });

        // Convertir en image
        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        // Ajouter une nouvelle page si ce n'est pas la premi√®re
        if (i > 0) {
          pdf.addPage();
        }

        // Dimensions A4 en mm
        const pdfWidth = 210;
        const pdfHeight = 297;

        // Ajouter l'image au PDF (pleine page)
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
      }

      // T√©l√©charger le PDF
      const filename = `etiquettes-produits-${new Date().toISOString().split('T')[0]}.pdf`;
      pdf.save(filename);

      setProgress(100);
      
      // Message de succ√®s
      setTimeout(() => {
        alert(`‚úÖ PDF g√©n√©r√© avec succ√®s !\n\n${totalPages} page(s) - ${data.length} √©tiquette(s)`);
        setIsGenerating(false);
        setProgress(0);
      }, 500);

    } catch (error) {
      console.error('Erreur lors de la g√©n√©ration du PDF:', error);
      alert('‚ùå Erreur lors de la g√©n√©ration du PDF. Veuillez r√©essayer.');
      setIsGenerating(false);
      setProgress(0);
    }
  };

  return (
    <div className="relative">
      <button
        onClick={generatePDF}
        disabled={isGenerating || data.length === 0}
        className={`px-6 py-3 rounded-lg font-medium transition flex items-center space-x-2 ${
          isGenerating || data.length === 0
            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
            : 'bg-green-600 text-white hover:bg-green-700 shadow-lg hover:shadow-xl'
        }`}
      >
        {isGenerating ? (
          <>
            <svg
              className="animate-spin h-5 w-5 text-white"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                className="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="4"
              />
              <path
                className="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              />
            </svg>
            <span>G√©n√©ration... {progress}%</span>
          </>
        ) : (
          <>
            <svg
              className="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <span>T√©l√©charger le PDF</span>
          </>
        )}
      </button>

      {/* Barre de progression */}
      {isGenerating && (
        <div className="absolute -bottom-2 left-0 right-0 h-1 bg-gray-200 rounded-full overflow-hidden">
          <div
            className="h-full bg-green-600 transition-all duration-300"
            style={{ width: `${progress}%` }}
          />
        </div>
      )}
    </div>
  );
}


/**
 * UTILITAIRES : Fonctions helpers pour le module de publipostage
 */

/**
 * Formate un prix en euros
 * Accepte diff√©rents formats d&apos;entr√©e et normalise l'affichage
 * 
 * Exemples :
 * - "109" ‚Üí "109,00 ‚Ç¨"
 * - "109.00" ‚Üí "109,00 ‚Ç¨"
 * - "109,00‚Ç¨" ‚Üí "109,00 ‚Ç¨"
 * - "109.99" ‚Üí "109,99 ‚Ç¨"
 * - "1099" ‚Üí "1 099,00 ‚Ç¨"
 */
export function formatPrice(price: string | number): string {
  if (!price) return '0,00 ‚Ç¨';

  // Convertir en string et nettoyer
  let priceStr = String(price)
    .trim()
    .replace(/\s/g, '') // Supprimer les espaces
    .replace(/‚Ç¨/g, ''); // Supprimer le symbole ‚Ç¨

  // Remplacer la virgule par un point pour la conversion num√©rique
  priceStr = priceStr.replace(',', '.');

  // Convertir en nombre
  const priceNum = parseFloat(priceStr);

  // V√©rifier si c'est un nombre valide
  if (isNaN(priceNum)) {
    return price.toString(); // Retourner tel quel si non valide
  }

  // Formater avec s√©parateurs de milliers et 2 d√©cimales
  const formatted = priceNum.toLocaleString('fr-FR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });

  return `${formatted} ‚Ç¨`;
}

/**
 * Normalise une note sur 10
 * Accepte diff√©rents formats et retourne une string format√©e
 * 
 * Exemples :
 * - "8.1" ‚Üí "8.1"
 * - "8,5" ‚Üí "8.5"
 * - 7 ‚Üí "7.0"
 */
export function formatNote(note: string | number): string {
  if (!note) return '';

  // Convertir en string et nettoyer
  const noteStr = String(note)
    .trim()
    .replace(',', '.');

  const noteNum = parseFloat(noteStr);

  if (isNaN(noteNum)) {
    return note.toString();
  }

  // Limiter entre 0 et 10
  const normalized = Math.max(0, Math.min(10, noteNum));

  // Retourner avec 1 d√©cimale
  return normalized.toFixed(1);
}

/**
 * Tronque un texte √† une longueur maximale
 * Ajoute "..." si le texte est tronqu√©
 */
export function truncateText(text: string, maxLength: number): string {
  if (!text || text.length <= maxLength) return text;
  return text.substring(0, maxLength - 3) + '...';
}

/**
 * Nettoie et normalise une valeur de cellule Excel/CSV
 * Supprime les espaces superflus, les retours √† la ligne, etc.
 */
export function cleanCellValue(value: string | number | null | undefined): string {
  if (value === null || value === undefined) return '';
  
  return String(value)
    .trim()
    .replace(/\s+/g, ' ')
    .replace(/\n/g, ' ');
}

/**
 * D√©tecte automatiquement le type de devise dans un texte
 */
export function detectCurrency(text: string): string {
  const currencies = ['‚Ç¨', '$', '¬£', 'EUR', 'USD', 'GBP'];
  
  for (const currency of currencies) {
    if (text.includes(currency)) {
      return currency;
    }
  }
  
  return '‚Ç¨'; // Par d√©faut
}

/**
 * Valide si une cha√Æne est un prix valide
 */
export function isValidPrice(price: string): boolean {
  if (!price) return false;
  
  const cleaned = price.replace(/[‚Ç¨$¬£\s]/g, '').replace(',', '.');
  const num = parseFloat(cleaned);
  
  return !isNaN(num) && num >= 0;
}

/**
 * G√©n√®re un ID unique simple
 */
export function generateId(): string {
  return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
}

/**
 * T√©l√©charge un fichier Blob
 */
export function downloadBlob(blob: Blob, filename: string): void {
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/**
 * Formatte une date au format fran√ßais
 */
export function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}

/**
 * Compte le nombre de pages n√©cessaires pour un nombre d&apos;√©tiquettes donn√©
 */
export function calculatePages(labelCount: number, labelsPerPage: number = 4): number {
  return Math.ceil(labelCount / labelsPerPage);
}